var Emulator;(function(n){var t=function(){function t(t,i,r){var u=this;this.memory=new Array(Constants.Memory.Size),this.runner=null,this.instructions=0,this.lastCheck=0,this.operationMap=[],this.consoleService=t,this.displayService=i,this.log=function(n){return u.consoleService.log(n)},this.timeoutService=r,n.OpCodes.FillOps(this.operationMap),this.autoRefresh=!0,this.debug=!1,this.reset()}return t.prototype.stop=function(){this.runningState=!1,this.runner!=null&&(this.timeoutService.cancel(this.runner),this.runner=null)},t.prototype.halt=function(){this.stop(),this.errorState=!0,this.consoleService.log("Processing has been halted. RESET to continue.")},t.prototype.reset=function(){var n;for(this.rA=0,this.rX=0,this.rY=0,this.rP=0,this.rPC=Constants.Memory.DefaultStart,this.rSP=Constants.Memory.Stack,this.started=null,this.elapsedMilliseconds=0,this.instructionsPerSecond=0,this.lastCheck=null,this.instructions=0,n=0;n<this.memory.length;n++)this.memory[n]=0;for(n=0;n<this.displayService.pixels.length;n++)this.displayService.pixels[n]!==0&&this.displayService.draw(n,0);this.runningState=!1,this.errorState=!1,this.consoleService.log("CPU has been successfully reset.")},t.prototype.step=function(){if(this.errorState){this.consoleService.log("Cannot run in error state. Please RESET first.");return}this.runningState=!0,this.started=new Date,this.lastCheck=this.started.getTime(),this.execute(),this.stop()},t.prototype.run=function(){var n=this;if(this.runningState){this.consoleService.log("Already running.");return}if(this.errorState){this.consoleService.log("Cannot run in error state. Please RESET first.");return}this.runningState=!0,this.started=new Date,this.lastCheck=this.started.getTime(),this.runner=this.timeoutService(function(){return n.executeBatch.apply(n)},1,this.autoRefresh)},t.prototype.executeBatch=function(){var t=this,i,n;if(this.runningState&&!this.errorState){for(i=255;i--;)this.execute();this.runner=this.timeoutService(function(){return t.executeBatch.apply(t)},0,this.autoRefresh),n=new Date,this.elapsedMilliseconds=n.getTime()-this.started.getTime(),n.getTime()-this.lastCheck>1e3&&(this.instructionsPerSecond=this.instructions,this.instructions=0,this.lastCheck=n.getTime())}},t.prototype.execute=function(){if(this.runningState&&!this.errorState){try{var n=this.rPC,t=this.operationMap[this.addrPop()];this.debug&&this.consoleService.log(t.decompile(n,[t.opCode,this.memory[n+1],this.memory[n+2]])),t.execute(this)}catch(i){this.consoleService.log("Unexpected exception: "+i),this.halt()}this.instructions+=1}},t.prototype.checkFlag=function(n){return(this.rP&n)>0},t.prototype.setFlag=function(n,t){var i=Constants.Memory.ByteMask-n;t?this.rP|=n:this.rP&=i},t.prototype.stackPush=function(n){if(this.rSP>=0)return this.rSP-=1,this.memory[this.rSP+Constants.Memory.Stack]=n,!0;throw"Stack overflow.";},t.prototype.stackPop=function(){if(this.rSP<Constants.Memory.Stack){var n=this.memory[this.rSP+Constants.Memory.Stack];return this.rSP++,n}throw"Tried to pop empty stack.";},t.prototype.stackRts=function(){this.rPC=this.stackPop()+1+(this.stackPop()<<Constants.Memory.BitsInByte)},t.prototype.addrPop=function(){var n=this.peek(this.rPC);return this.rPC+=1,n},t.prototype.addrPopWord=function(){return this.addrPop()+(this.addrPop()<<Constants.Memory.BitsInByte)},t.prototype.poke=function(n,t){this.memory[n&Constants.Memory.Max]=t&Constants.Memory.ByteMask,n>=Constants.Display.DisplayStart&&n<=Constants.Display.DisplayStart+Constants.Display.Max&&this.displayService.draw(n,t)},t.prototype.peek=function(n){return n===Constants.Memory.ZeroPageRandomNumberGenerator?Math.floor(Math.random()*256):this.memory[n&65535]},t.prototype.setFlags=function(n){n&Constants.ProcessorStatus.NegativeFlagSet?this.rP|=Constants.ProcessorStatus.NegativeFlagSet:this.rP&=Constants.ProcessorStatus.NegativeFlagReset,n?this.rP&=Constants.ProcessorStatus.ZeroFlagReset:this.rP|=Constants.ProcessorStatus.ZeroFlagSet},t.prototype.compareWithFlags=function(n,t){var r,i;i=Constants.Memory.ByteMask+n-t+1,this.setFlag(Constants.ProcessorStatus.CarryFlagSet,i>=256),r=i&Constants.Memory.ByteMask,this.setFlags(r)},t.prototype.addrAbsoluteX=function(){return this.addrPopWord()+this.rX&Constants.Memory.Max},t.prototype.addrAbsoluteY=function(){return this.addrPopWord()+this.rY&Constants.Memory.Max},t.prototype.addrIndirect=function(){var n=this.addrPopWord(),t=this.peek(n)+(this.peek(n+1)<<Constants.Memory.BitsInByte);return t&Constants.Memory.Max},t.prototype.addrIndexedIndirectX=function(){var n=this.addrPop()+this.rX&Constants.Memory.ByteMask;return this.peek(n)+(this.peek(n+1)<<Constants.Memory.BitsInByte)},t.prototype.addrIndirectIndexedY=function(){var n=this.addrPop();return this.peek(n)+(this.peek(n+1)<<Constants.Memory.BitsInByte)+this.rY},t.prototype.addrZeroPageX=function(){return this.addrPop()+this.rX&Constants.Memory.ByteMask},t.prototype.addrZeroPageY=function(){return this.addrPop()+this.rY&Constants.Memory.ByteMask},t.prototype.getOperation=function(n){return this.operationMap[n&Constants.Memory.ByteMask]},t}();n.Cpu=t})(Emulator||(Emulator={}))